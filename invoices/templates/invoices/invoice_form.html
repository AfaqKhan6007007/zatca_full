{% extends 'invoices/base.html' %}

{% block title %}{{ action }} Invoice - ZATCA E-Invoice{% endblock %}

{% block extra_css %}
<style>
    .formset-row {
        border: 1px solid #dee2e6;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-file-earmark-plus"></i> {{ action }} Invoice</h1>
    </div>
</div>

<form method="post" id="invoice-form">
    {% csrf_token %}
    
    <div class="card mb-3">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Invoice Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Invoice Number</label>
                        {{ form.invoice_number }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Invoice Type</label>
                        {{ form.invoice_type }}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Issue Date</label>
                        {{ form.issue_date }}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Issue Time</label>
                        {{ form.issue_time }}
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Company</label>
                        {{ form.company }}
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label class="form-label">Customer</label>
                        {{ form.customer }}
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Discount (SAR)</label>
                {{ form.discount }}
            </div>
            
            <div class="mb-3">
                <label class="form-label">Notes</label>
                {{ form.notes }}
            </div>
        </div>
    </div>
    
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Invoice Items</h5>
        </div>
        <div class="card-body">
            {{ formset.management_form }}
            
            <div id="invoice-items">
                {% for item_form in formset %}
                <div class="formset-row" data-formset-form>
                    {{ item_form.id }}
                    {% if item_form.instance.pk %}{{ item_form.DELETE }}{% endif %}
                    
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Description</label>
                            {{ item_form.description }}
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Quantity</label>
                            {{ item_form.quantity }}
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Unit Price</label>
                            {{ item_form.unit_price }}
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">VAT Rate %</label>
                            {{ item_form.vat_rate }}
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Discount</label>
                            {{ item_form.discount }}
                        </div>
                    </div>
                    
                    {% if not forloop.first %}
                    <button type="button" class="btn btn-sm btn-danger mt-2 remove-form-row">
                        <i class="bi bi-trash"></i> Remove
                    </button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            
            <button type="button" class="btn btn-secondary" id="add-item">
                <i class="bi bi-plus-circle"></i> Add Item
            </button>
        </div>
    </div>
    
    <div class="d-flex justify-content-between">
        <a href="{% url 'invoice_list' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-save"></i> Save Invoice
        </button>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formsetContainer = document.getElementById('invoice-items');
    const addButton = document.getElementById('add-item');
    const totalForms = document.querySelector('#id_items-TOTAL_FORMS');
    
    // Add new form
    addButton.addEventListener('click', function() {
        const formCount = parseInt(totalForms.value);
        const newForm = document.querySelector('[data-formset-form]').cloneNode(true);
        
        // Update form index
        newForm.innerHTML = newForm.innerHTML.replace(/items-\d+-/g, `items-${formCount}-`);
        newForm.querySelectorAll('input, select, textarea').forEach(input => {
            input.value = '';
            if (input.name.includes('vat_rate')) input.value = '15.00';
            if (input.name.includes('discount')) input.value = '0.00';
        });
        
        // Add remove button
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-sm btn-danger mt-2 remove-form-row';
        removeBtn.innerHTML = '<i class="bi bi-trash"></i> Remove';
        newForm.appendChild(removeBtn);
        
        formsetContainer.appendChild(newForm);
        totalForms.value = formCount + 1;
    });
    
    // Remove form
    formsetContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-form-row')) {
            const formRow = e.target.closest('[data-formset-form]');
            const deleteCheckbox = formRow.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                formRow.style.display = 'none';
            } else {
                formRow.remove();
                const formCount = parseInt(totalForms.value);
                totalForms.value = formCount - 1;
            }
        }
    });
});
</script>
{% endblock %}
